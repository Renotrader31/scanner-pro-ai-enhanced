<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Direct FMP API Integration</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1f3a;
            color: white;
        }
        .container {
            background: rgba(31, 41, 55, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover { background: #2563EB; }
        #results {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stock-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 15px;
            border-radius: 8px;
        }
        .stock-ticker {
            font-weight: bold;
            font-size: 1.2em;
            color: #60A5FA;
        }
        .stock-price {
            font-size: 1.4em;
            color: #22C55E;
            margin: 5px 0;
        }
        .stock-change {
            font-size: 0.9em;
        }
        .positive { color: #22C55E; }
        .negative { color: #EF4444; }
    </style>
</head>
<body>
    <h1>üöÄ Direct FMP API Integration Test</h1>
    
    <div class="container">
        <h2>Test Direct FMP API (Bypass Serverless Functions)</h2>
        <p>This test bypasses all proxy/serverless functions and calls FMP API directly from the browser.</p>
        
        <label for="universeSelect">Select Universe:</label>
        <select id="universeSelect" style="padding: 8px; margin: 10px; background: #374151; color: white; border: 1px solid #4B5563; border-radius: 4px;">
            <option value="popular">Popular Stocks (48)</option>
            <option value="crypto_miners">Crypto Miners (24)</option>
            <option value="growth">Growth Stocks (24)</option>
            <option value="biotech">Biotech (24)</option>
            <option value="tech_pure">Pure Tech (24)</option>
            <option value="sp500_top50">S&P 500 Top 50</option>
        </select>
        
        <button onclick="testDirectFMP()">üî• Test Direct FMP API</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <div class="container">
        <h3>üìä Console Log</h3>
        <div id="results">Click "Test Direct FMP API" to start...</div>
    </div>

    <div class="container">
        <h3>üìà Live Stock Data</h3>
        <div id="stockResults" class="stock-grid"></div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            FMP_API_KEY: 'm2XfxOS0sZxs6hLEY5yRzUgDyp5Dur4V',
            FMP_BASE_URL: 'https://financialmodelingprep.com/api/v3'
        };

        function log(message) {
            console.log(message);
            document.getElementById('results').textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            document.getElementById('results').scrollTop = document.getElementById('results').scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').textContent = '';
            document.getElementById('stockResults').innerHTML = '';
        }

        async function testDirectFMP() {
            log('üöÄ Starting Direct FMP API Test...');
            
            const selectedUniverse = document.getElementById('universeSelect').value;
            log(`üìä Selected universe: ${selectedUniverse}`);
            
            try {
                const stockData = await fetchDirectFMPData(selectedUniverse);
                
                if (stockData && stockData.length > 0) {
                    log(`‚úÖ SUCCESS! Fetched ${stockData.length} stocks from FMP API`);
                    log(`üìà Sample data: ${stockData.slice(0, 3).map(s => `${s.ticker}: $${s.price}`).join(', ')}`);
                    
                    // Display results
                    displayStockResults(stockData);
                } else {
                    log('‚ùå No data received');
                }
                
            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                console.error(error);
            }
        }

        async function fetchDirectFMPData(universe) {
            log('üåê DIRECT FMP API - Fetching universe: ' + universe);
            
            // Define comprehensive stock universes (same as main app)
            const universes = {
                'popular': [
                    'AAPL', 'MSFT', 'NVDA', 'GOOGL', 'GOOG', 'AMZN', 'META', 'TSLA',
                    'NFLX', 'AMD', 'CRM', 'INTC', 'ORCL', 'ADBE', 'CSCO', 'AVGO',
                    'JPM', 'BAC', 'WFC', 'GS', 'MS', 'C', 'AXP', 'BLK',
                    'JNJ', 'PFE', 'UNH', 'ABBV', 'MRK', 'TMO', 'ABT', 'DHR',
                    'KO', 'PEP', 'WMT', 'HD', 'MCD', 'DIS', 'NKE', 'SBUX',
                    'XOM', 'CVX', 'COP', 'EOG', 'SLB', 'MPC', 'VLO', 'PSX'
                ],
                'crypto_miners': [
                    'MSTR', 'COIN', 'MARA', 'RIOT', 'CLSK', 'BITF', 'HUT', 'BTBT',
                    'CAN', 'ARGO', 'EBON', 'SOS', 'ANY', 'EBANG', 'NCTY', 'PHUN',
                    'SDIG', 'WULF', 'IREN', 'CORZ', 'CIFR', 'BTC', 'GREE', 'SPRT'
                ],
                'growth': [
                    'NVDA', 'TSLA', 'AMD', 'CRM', 'SHOP', 'SQ', 'ROKU', 'ZM',
                    'PLTR', 'SNOW', 'NET', 'DDOG', 'CRWD', 'ZS', 'OKTA', 'TWLO',
                    'TEAM', 'DOCU', 'SPLK', 'WDAY', 'NOW', 'VEEV', 'ADSK', 'ANSS'
                ],
                'biotech': [
                    'GILD', 'AMGN', 'BIIB', 'REGN', 'VRTX', 'ILMN', 'MRNA', 'BNTX',
                    'SGEN', 'ALNY', 'BMRN', 'TECH', 'SRPT', 'RARE', 'BLUE', 'FOLD',
                    'ARWR', 'EDIT', 'CRSP', 'NTLA', 'BEAM', 'PRME', 'VCYT', 'PACB'
                ],
                'tech_pure': [
                    'AAPL', 'MSFT', 'NVDA', 'GOOGL', 'META', 'TSLA', 'CRM', 'ORCL',
                    'ADBE', 'NOW', 'INTU', 'AMD', 'QCOM', 'INTC', 'TXN', 'LRCX',
                    'KLAC', 'AMAT', 'MU', 'NXPI', 'MRVL', 'ADI', 'SNPS', 'CDNS'
                ],
                'sp500_top50': [
                    'AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'GOOG', 'META', 'TSLA',
                    'BRK-B', 'LLY', 'AVGO', 'JPM', 'WMT', 'V', 'UNH', 'XOM',
                    'MA', 'PG', 'JNJ', 'HD', 'CVX', 'ABBV', 'NFLX', 'BAC',
                    'KO', 'CRM', 'COST', 'ASML', 'MRK', 'AMD', 'PEP', 'TMO',
                    'LIN', 'ACN', 'CSCO', 'ABT', 'ADBE', 'DHR', 'TXN', 'MCD',
                    'VZ', 'NEE', 'ORCL', 'WFC', 'PM', 'COP', 'NVS', 'BMY',
                    'DIS', 'INTC'
                ]
            };
            
            // Get tickers for the requested universe
            const tickerList = universes[universe] || universes['popular'];
            log(`üìä Processing ${tickerList.length} stocks for ${universe} universe`);
            
            const quotes = [];
            const batchSize = 8; // Process 8 stocks per batch for stability
            
            // Process in batches to avoid API limits
            for (let i = 0; i < tickerList.length; i += batchSize) {
                const batch = tickerList.slice(i, i + batchSize);
                log(`üîÑ Processing batch ${Math.floor(i/batchSize) + 1}: ${batch.join(', ')}`);
                
                try {
                    // Use FMP batch quote endpoint
                    const tickerString = batch.join(',');
                    const url = `${API_CONFIG.FMP_BASE_URL}/quote/${tickerString}?apikey=${API_CONFIG.FMP_API_KEY}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        log(`‚ö†Ô∏è Batch ${Math.floor(i/batchSize) + 1} failed: ${response.status}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    if (data && Array.isArray(data)) {
                        for (const quote of data) {
                            quotes.push({
                                ticker: quote.symbol,
                                price: quote.price,
                                change: quote.changesPercentage,
                                change_amount: quote.change,
                                volume: quote.volume,
                                market_cap: quote.marketCap,
                                pe: quote.pe,
                                timestamp: new Date().toLocaleTimeString()
                            });
                        }
                        log(`   ‚úÖ Batch ${Math.floor(i/batchSize) + 1}: ${data.length} stocks fetched`);
                    }
                    
                    // Add small delay between batches to avoid rate limits
                    if (i + batchSize < tickerList.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                    
                } catch (error) {
                    log(`‚ö†Ô∏è Error processing batch ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                    continue;
                }
            }
            
            log(`‚úÖ DIRECT FMP API: Successfully fetched ${quotes.length} stocks`);
            return quotes;
        }

        function displayStockResults(stockData) {
            const container = document.getElementById('stockResults');
            container.innerHTML = '';
            
            stockData.forEach(stock => {
                const card = document.createElement('div');
                card.className = 'stock-card';
                
                const changeClass = stock.change >= 0 ? 'positive' : 'negative';
                const changeSymbol = stock.change >= 0 ? '+' : '';
                
                card.innerHTML = `
                    <div class="stock-ticker">${stock.ticker}</div>
                    <div class="stock-price">$${stock.price?.toFixed(2) || 'N/A'}</div>
                    <div class="stock-change ${changeClass}">${changeSymbol}${stock.change?.toFixed(2) || 'N/A'}%</div>
                    <div style="font-size: 0.8em; color: #9CA3AF; margin-top: 5px;">
                        Vol: ${formatVolume(stock.volume)}<br>
                        P/E: ${stock.pe || 'N/A'}<br>
                        ${stock.timestamp}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function formatVolume(volume) {
            if (!volume) return 'N/A';
            if (volume > 1e9) return (volume / 1e9).toFixed(1) + 'B';
            if (volume > 1e6) return (volume / 1e6).toFixed(1) + 'M';
            if (volume > 1e3) return (volume / 1e3).toFixed(1) + 'K';
            return volume.toString();
        }
    </script>
</body>
</html>